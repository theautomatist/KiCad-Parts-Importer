# GitHub Actions: Release CI (exactly 4 jobs)
# Jobs:
#  1) build_extension  – zip Chrome extension, create/append GitHub Release
#  2) package_windows  – PyInstaller onedir + Inno Setup .exe installer, append Release
#  3) package_linux    – PyInstaller onedir + fpm .deb/.rpm, append Release
#  4) package_macos    – PyInstaller onedir + .pkg (LaunchDaemon), append Release
#
# Trigger: tag push (vX.Y.Z) or manual (workflow_dispatch)
# Assumptions:
#  - Entry script: run_server.py at repo root
#  - App name/binary folder: easyeda2kicad-api
#  - Chrome extension lives in ./chrome_extension (contains manifest.json)
#  - No external packaging files needed; Windows .iss & macOS LaunchDaemon are generated on-the-fly
#
# Notes:
#  - Jobs 2–4 depend on job 1 so the Release exists before they append artifacts.
#  - For Chrome Web Store publish, set secrets and the optional step will run.
#  - For macOS notarization or Windows code-signing, add secrets and steps as needed later.

name: Release CI (4 Jobs)

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch: {}

permissions:
  contents: write # required for release asset uploads

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  APPNAME: easyeda2kicad-api
  PYTHON_VERSION: "3.12"
  PORT: "8087"
  EXT_DIR: chrome_extension

jobs:
  build_extension:
    name: Build Chrome Extension & create release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure directory exists and manifest present
        run: |
          test -d "$EXT_DIR" || { echo "Not found: $EXT_DIR"; exit 1; }
          test -f "$EXT_DIR/manifest.json" || { echo "manifest.json fehlt in $EXT_DIR"; exit 1; }

      - name: Setup Node if package.json exists
        if: ${{ hashFiles(format('{0}/package.json', env.EXT_DIR)) != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build (optional)
        if: ${{ hashFiles(format('{0}/package.json', env.EXT_DIR)) != '' }}
        working-directory: ${{ env.EXT_DIR }}
        run: |
          npm ci
          if npm run | grep -q " build"; then npm run build; fi

      - name: Set manifest version from tag (optional)
        if: ${{ startsWith(github.ref, 'refs/tags/') }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          VER=${GITHUB_REF_NAME#v}
          FILE="$EXT_DIR/manifest.json"
          tmp=$(mktemp)
          jq --arg v "$VER" '.version = $v' "$FILE" > "$tmp" && mv "$tmp" "$FILE"
          cat "$FILE" | jq '.version'

      - name: Zip extension (dist/ preferred if exists)
        run: |
          SRC="$EXT_DIR"
          if [ -d "$EXT_DIR/dist" ]; then SRC="$EXT_DIR/dist"; fi
          zip -r extension.zip "$SRC" -x "**/node_modules/**" "**/.git/**" "**/.vscode/**" "**/*.map"
          ls -lh extension.zip

      - name: Upload artifact (Actions)
        uses: actions/upload-artifact@v4
        with:
          name: extension-zip
          path: extension.zip

      - name: Create/Update GitHub Release with extension
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: extension.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: (Optional) Publish to Chrome Web Store
        if: ${{ secrets.CWS_CLIENT_ID != '' && secrets.CWS_CLIENT_SECRET != '' && secrets.CWS_REFRESH_TOKEN != '' && secrets.CWS_EXTENSION_ID != '' }}
        run: |
          npm --version || (echo "Node required" && exit 1)
          npx chrome-webstore-upload-cli \
            upload --source extension.zip \
            --extension-id "$CWS_EXTENSION_ID" \
            --client-id "$CWS_CLIENT_ID" \
            --client-secret "$CWS_CLIENT_SECRET" \
            --refresh-token "$CWS_REFRESH_TOKEN"
          npx chrome-webstore-upload-cli \
            publish --extension-id "$CWS_EXTENSION_ID" \
            --client-id "$CWS_CLIENT_ID" \
            --client-secret "$CWS_CLIENT_SECRET" \
            --refresh-token "$CWS_REFRESH_TOKEN"
        env:
          CWS_CLIENT_ID: ${{ secrets.CWS_CLIENT_ID }}
          CWS_CLIENT_SECRET: ${{ secrets.CWS_CLIENT_SECRET }}
          CWS_REFRESH_TOKEN: ${{ secrets.CWS_REFRESH_TOKEN }}
          CWS_EXTENSION_ID: ${{ secrets.CWS_EXTENSION_ID }}

  package_windows:
    name: Windows – Build binary & Inno Setup installer
    runs-on: windows-latest
    needs: build_extension
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip wheel
          if (Test-Path requirements.txt) { pip install -r requirements.txt }
          pip install pyinstaller fastapi "uvicorn[h11]" anyio starlette websockets h11 certifi

      - name: Build PyInstaller binary (onedir)
        shell: pwsh
        run: |
          pyinstaller run_server.py \
            --name $env:APPNAME \
            --onedir \
            --collect-submodules anyio \
            --collect-submodules starlette \
            --collect-submodules websockets \
            --collect-submodules h11 \
            --collect-data certifi \
            --exclude-module uvloop \
            --exclude-module httptools \
            --exclude-module watchfiles

      - name: Generate Inno Setup script
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path packaging\windows | Out-Null
          @'
          #define AppVersion GetStringParam("AppVersion", "1.0.0")
          #define SourceDir  GetStringParam("SourceDir", ".")
          #define OutputDir  GetStringParam("OutputDir", ".")

          [Setup]
          AppName=EasyEDA2KiCad API
          AppVersion={#AppVersion}
          DefaultDirName={pf}\EasyEDA2KiCad API
          OutputDir={#OutputDir}
          OutputBaseFilename=EasyEDA2KiCad-API-Setup
          ArchitecturesInstallIn64BitMode=x64

          [Files]
          Source: "{#SourceDir}\\*"; DestDir: "{app}"; Flags: recursesubdirs

          [Icons]
          Name: "{group}\\Start API Server"; Filename: "{app}\\easyeda2kicad-api.exe"; Parameters: "--port 8087"

          [Run]
          Filename: "{app}\\easyeda2kicad-api.exe"; Parameters: "--port 8087"; Flags: nowait postinstall skipifsilent
          '@ | Set-Content -Path packaging\windows\installer.iss -Encoding ascii

      - name: Install Inno Setup & build installer
        shell: pwsh
        run: |
          choco install innosetup -y
          $iscc = "C:\\Program Files (x86)\\Inno Setup 6\\ISCC.exe"
          $src  = Join-Path $PWD "dist\$env:APPNAME"
          $out  = Join-Path $PWD "out"
          New-Item -ItemType Directory -Force -Path $out | Out-Null
          $ver  = "${env:GITHUB_REF_NAME}".TrimStart('v')
          & $iscc "packaging\\windows\\installer.iss" \
            "/DAppVersion=$ver" \
            "/DSourceDir=$src" \
            "/DOutputDir=$out"

      - name: Upload artifacts (Actions)
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: out/*

      - name: Append assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: out/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  package_linux:
    name: Linux – Build binary & .deb/.rpm
    runs-on: ubuntu-20.04
    needs: build_extension
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pyinstaller fastapi "uvicorn[h11]" anyio starlette websockets h11 certifi

      - name: Build PyInstaller binary (onedir)
        run: |
          pyinstaller run_server.py \
            --name "$APPNAME" \
            --onedir \
            --collect-submodules anyio \
            --collect-submodules starlette \
            --collect-submodules websockets \
            --collect-submodules h11 \
            --collect-data certifi \
            --exclude-module uvloop \
            --exclude-module httptools \
            --exclude-module watchfiles

      - name: Install fpm & package .deb and .rpm
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby-dev build-essential rpm
          sudo gem install --no-document fpm

          mkdir -p pkgroot/opt/$APPNAME pkgroot/lib/systemd/system out
          cp -r dist/$APPNAME/. pkgroot/opt/$APPNAME/

          # Generate systemd unit
          cat > pkgroot/lib/systemd/system/$APPNAME.service <<UNIT
          [Unit]
          Description=EasyEDA2KiCad API
          After=network.target

          [Service]
          WorkingDirectory=/opt/$APPNAME
          ExecStart=/opt/$APPNAME/$APPNAME --port $PORT
          Restart=on-failure
          User=root

          [Install]
          WantedBy=multi-user.target
          UNIT

          VER=${GITHUB_REF_NAME#v}
          fpm -s dir -t deb -n $APPNAME -v "$VER" \
              --deb-systemd pkgroot/lib/systemd/system/$APPNAME.service \
              -C pkgroot .
          fpm -s dir -t rpm -n $APPNAME -v "$VER" \
              --rpm-os linux \
              -C pkgroot .
          mv *.deb *.rpm out/

      - name: Upload artifacts (Actions)
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: out/*

      - name: Append assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: out/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  package_macos:
    name: macOS – Build binary & .pkg
    runs-on: macos-14
    needs: build_extension
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pyinstaller fastapi "uvicorn[h11]" anyio starlette websockets h11 certifi

      - name: Build PyInstaller binary (onedir)
        run: |
          pyinstaller run_server.py \
            --name "$APPNAME" \
            --onedir \
            --collect-submodules anyio \
            --collect-submodules starlette \
            --collect-submodules websockets \
            --collect-submodules h11 \
            --collect-data certifi \
            --exclude-module uvloop \
            --exclude-module httptools \
            --exclude-module watchfiles

      - name: Package .pkg (with LaunchDaemon)
        shell: bash
        run: |
          set -euo pipefail
          APPNAME="$APPNAME"; VER=${GITHUB_REF_NAME#v}
          mkdir -p pkgroot/opt/$APPNAME pkgroot/Library/LaunchDaemons out
          cp -R dist/$APPNAME/. pkgroot/opt/$APPNAME/

          # Generate LaunchDaemon plist
          cat > pkgroot/Library/LaunchDaemons/com.yourorg.${APPNAME}.plist <<'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>Label</key><string>com.yourorg.easyeda2kicad-api</string>
            <key>ProgramArguments</key>
            <array>
              <string>/opt/easyeda2kicad-api/easyeda2kicad-api</string>
              <string>--port</string><string>${PORT}</string>
            </array>
            <key>RunAtLoad</key><true/>
            <key>KeepAlive</key><true/>
            <key>StandardOutPath</key><string>/var/log/easyeda2kicad-api.out</string>
            <key>StandardErrorPath</key><string>/var/log/easyeda2kicad-api.err</string>
          </dict>
          </plist>
          PLIST

          sudo chown -R root:wheel pkgroot
          /usr/bin/pkgbuild \
            --identifier com.yourorg.$APPNAME \
            --version "$VER" \
            --install-location / \
            --root pkgroot \
            out/$APPNAME-$VER.pkg

      - name: Upload artifacts (Actions)
        uses: actions/upload-artifact@v4
        with:
          name: macos-pkg
          path: out/*

      - name: Append assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: out/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
